# Блок‑схемы алгоритмов CURSA

Ниже приведены переработанные блок‑схемы основных процессов системы. Схемы ориентированы на требования ГОСТ 19.701‑90: поток сверху вниз, явные начала/концы, подписи ветвей решений «ДА/НЕТ», единые обозначения шагов.

> Примечание: в репозитории схемы заданы в формате Mermaid, который корректно отображается на GitHub и в ряде редакторов. При необходимости их легко экспортировать в PNG/SVG.

---

## 1. Проверка документа (Upload → Analyze)

```mermaid
flowchart TD
    A([Начало]) --> B[/Загрузка файла DOCX/]
    B --> C[Сохранить во временную директорию]
    C --> D[Извлечь данные: DocumentProcessor]
    D --> E{Данные извлечены?}
    E -- НЕТ --> E1[Ответ 500: "Не удалось извлечь данные"] --> Z([Конец])
    E -- ДА --> F[Загрузить активный профиль норм (profile_id)]
    F --> G{Профиль валиден?}
    G -- НЕТ --> G1[Ответ 400: "Неверная конфигурация профиля"] --> Z
    G -- ДА --> H[NormControlChecker.check_document()]
    H --> I[Сформировать JSON: filename, check_results, profile_id]
    I --> Z([Конец])
```

---

## 2. Исправление документа (Correct)

```mermaid
flowchart TD
    A([Начало]) --> B[/POST /api/document/correct/]
    B --> C{Путь к файлу указан?}
    C -- НЕТ --> C1[Ответ 400: "Не указан путь к файлу"] --> Z([Конец])
    C -- ДА --> D{Файл существует?}
    D -- НЕТ --> D1[Попробовать добавить .docx] --> D2{Найден?}
    D2 -- НЕТ --> D3[Ответ 404: "Файл не найден"] --> Z
    D2 -- ДА --> E[Продолжить]
    D -- ДА --> E[Продолжить]
    E --> F[Сформировать имя для исправленного файла]
    F --> G[DocumentCorrector.correct_document() → save в static/corrections]
    G --> H{Файл создан?}
    H -- НЕТ --> H1[Ответ 500: "Файл не был создан"] --> Z
    H -- ДА --> I[Ответ 200: {success, corrected_file_path, filename}]
    I --> Z([Конец])
```

---

## 3. Скачивание исправленного файла (Download)

```mermaid
flowchart TD
    A([Начало]) --> B[/GET /api/document/download-corrected?path=.../]
    B --> C{Указан path?}
    C -- НЕТ --> C1[Ответ 400: "Не указан путь"] --> Z([Конец])
    C -- ДА --> D{Это имя файла без пути?}
    D -- ДА --> E[Искать в static/corrections/]
    D -- НЕТ --> F[Проверить абсолютный/относительный путь и с .docx]
    E --> G{Файл найден?}
    F --> G
    G -- НЕТ --> G1[Ответ 404: "Файл не найден"] --> Z
    G -- ДА --> H[send_file(..., as_attachment=True)]
    H --> Z([Конец])
```

---

## 4. Административная очистка старых файлов (Cleanup)

```mermaid
flowchart TD
    A([Начало]) --> B[/POST /api/document/admin/cleanup {days}/]
    B --> C[Вычислить cutoff_date = now - days]
    C --> D[Перебор *.docx в static/corrections]
    D --> E{mtime < cutoff_date?}
    E -- ДА --> F[Удалить файл; увеличить deleted_count]
    E -- НЕТ --> G[Оставить файл; увеличить kept_count]
    F --> H{Файлы остались?}
    G --> H
    H -- ДА --> D
    H -- НЕТ --> I[Ответ 200: {deleted_count, kept_count, deleted_files}]
    I --> Z([Конец])
```

---

## 5. Загрузка и применение профиля норм (Profiles)

```mermaid
flowchart TD
    A([Начало]) --> B[/Загрузка файла профиля (JSON|YAML)/]
    B --> C{Формат YAML?}
    C -- ДА --> C1[Конвертация YAML → JSON]
    C -- НЕТ --> C2[Использовать JSON как есть]
    C1 --> D
    C2 --> D
    D[Валидация по JSON Schema] --> E{Валидно?}
    E -- НЕТ --> E1[Отчёт об ошибках схемы; отклонить профиль] --> Z([Конец])
    E -- ДА --> F[Сохранить в backend/profiles/ под Git‑контролем]
    F --> G[Загрузить в кэш процесса Flask (profile_id)]
    G --> H[Применять параметры профиля в NormControlChecker]
    H --> Z([Конец])
```

---

### Руководство по оформлению (кратко)

- Поток сверху вниз; каждый алгоритм имеет один вход (Начало) и один выход (Конец).
- Ветви решений подписаны «ДА/НЕТ»; из ромба выходят строго две стрелки.
- На блоках — глаголы в повелительном наклонении: «Сохранить», «Проверить», «Удалить».
- Сообщения об ошибках приведены в кавычках ровно в том виде, в каком отдаёт API.
